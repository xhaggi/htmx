!function(e,t){"function"==typeof define&&define.amd?define(["htmx.org"],t):"object"==typeof module&&module.exports?module.exports=t(require("htmx.org")):t(e.htmx)}("undefined"!=typeof self?self:this,(function(e){return function(){var t;function n(e){return null!=t.getInternalData(e).webSocket}function r(e){return!t.bodyContains(e)&&(t.getInternalData(e).webSocket.close(),!0)}function s(t){var n=new WebSocket(t,[]);return n.binaryType=e.config.wsBinaryType,n}function i(e,n){var r=[];return(t.hasAttribute(e,n)||t.hasAttribute(e,"hx-ws"))&&r.push(e),e.querySelectorAll("["+n+"], [data-"+n+"], [data-hx-ws], [hx-ws]").forEach((function(e){r.push(e)})),r}function o(e,t){if(e)for(var n=0;n<e.length;n++)t(e[n])}e.defineExtension("ws",{init:function(n){t=n,e.createWebSocket||(e.createWebSocket=s),e.config.wsReconnectDelay||(e.config.wsReconnectDelay="full-jitter")},onEvent:function(s,a){switch(s){case"htmx:beforeCleanupElement":var c=t.getInternalData(a.target);return void(c.webSocket&&c.webSocket.close());case"htmx:afterProcessNode":var u=a.target;o(i(u,"ws-connect"),(function(n){!function(n){if(!t.bodyContains(n))return;var s=t.getAttributeValue(n,"ws-connect");if(null==s||""===s){var i=function(e){var n=t.getAttributeValue(e,"hx-ws");if(n)for(var r=n.trim().split(/\s+/),s=0;s<r.length;s++){var i=r[s].split(/:(.+)/);if("connect"===i[0])return i[1]}}(n);if(null==i)return;s=i}if(0===s.indexOf("/")){var o=location.hostname+(location.port?":"+location.port:"");"https:"===location.protocol?s="wss://"+o+s:"http:"===location.protocol&&(s="ws://"+o+s)}var a=function(n,s){var i={socket:null,messageQueue:[],retryCount:0,events:{},addEventListener:function(e,t){this.socket&&this.socket.addEventListener(e,t),this.events[e]||(this.events[e]=[]),this.events[e].push(t)},sendImmediately:function(e,n){this.socket||t.triggerErrorEvent(),n&&t.triggerEvent(n,"htmx:wsBeforeSend",{message:e,socketWrapper:this.publicInterface})&&(this.socket.send(e),n&&t.triggerEvent(n,"htmx:wsAfterSend",{message:e,socketWrapper:this.publicInterface}))},send:function(e,t){this.socket.readyState!==this.socket.OPEN?this.messageQueue.push({message:e,sendElt:t}):this.sendImmediately(e,t)},handleQueuedMessages:function(){for(;this.messageQueue.length>0;){var e=this.messageQueue[0];if(this.socket.readyState!==this.socket.OPEN)break;this.sendImmediately(e.message,e.sendElt),this.messageQueue.shift()}},init:function(){this.socket&&this.socket.readyState===this.socket.OPEN&&this.socket.close();var o=s();t.triggerEvent(n,"htmx:wsConnecting",{event:{type:"connecting"}}),this.socket=o,o.onopen=function(e){i.retryCount=0,t.triggerEvent(n,"htmx:wsOpen",{event:e,socketWrapper:i.publicInterface}),i.handleQueuedMessages()},o.onclose=function(s){if(!r(n)&&[1006,1012,1013].indexOf(s.code)>=0){var o=function(t){var n=e.config.wsReconnectDelay;if("function"==typeof n)return n(t);if("full-jitter"===n){var r=Math.min(t,6);return 1e3*Math.pow(2,r)*Math.random()}logError('htmx.config.wsReconnectDelay must either be a function or the string "full-jitter"')}(i.retryCount);setTimeout((function(){i.retryCount+=1,i.init()}),o)}t.triggerEvent(n,"htmx:wsClose",{event:s,socketWrapper:i.publicInterface})},o.onerror=function(e){t.triggerErrorEvent(n,"htmx:wsError",{error:e,socketWrapper:i}),r(n)};var a=this.events;Object.keys(a).forEach((function(e){a[e].forEach((function(t){o.addEventListener(e,t)}))}))},close:function(){this.socket.close()}};return i.init(),i.publicInterface={send:i.send.bind(i),sendImmediately:i.sendImmediately.bind(i),queue:i.messageQueue},i}(n,(function(){return e.createWebSocket(s)}));a.addEventListener("message",(function(e){if(!r(n)){var s=e.data;if(t.triggerEvent(n,"htmx:wsBeforeMessage",{message:s,socketWrapper:a.publicInterface})){t.withExtensions(n,(function(e){s=e.transformResponse(s,null,n)}));var i=t.makeSettleInfo(n),o=t.makeFragment(s);if(o.children.length)for(var c=Array.from(o.children),u=0;u<c.length;u++)t.oobSwap(t.getAttributeValue(c[u],"hx-swap-oob")||"true",c[u],i);t.settleImmediately(i.tasks),t.triggerEvent(n,"htmx:wsAfterMessage",{message:s,socketWrapper:a.publicInterface})}}})),t.getInternalData(n).webSocket=a}(n)})),o(i(u,"ws-send"),(function(e){!function(e){var s=t.getAttributeValue(e,"hx-ws");if(s&&"send"!==s)return;i=t.getClosestMatch(e,n),o=e,a=t.getInternalData(o),t.getTriggerSpecs(o).forEach((function(e){t.addTriggerHandler(o,e,a,(function(e,n){if(!r(i)){var s=t.getInternalData(i).webSocket,a=t.getHeaders(o,i),c=t.getInputValues(o,"post"),u=c.errors,f=c.values,l=t.getExpressionVars(o),g=t.mergeObjects(f,l),h={parameters:t.filterValues(g,o),unfilteredParameters:g,headers:a,errors:u,triggeringEvent:n,messageBody:void 0,socketWrapper:s.publicInterface};if(t.triggerEvent(e,"htmx:wsConfigSend",h))if(u&&u.length>0)t.triggerEvent(e,"htmx:validation:halted",u);else{var d=h.messageBody;if(void 0===d){var m=Object.assign({},h.parameters);h.headers&&(m.HEADERS=a),d=JSON.stringify(m)}s.send(d,e),t.shouldCancel(n,e)&&n.preventDefault()}}}))}));var i,o,a}(e)}))}}})}(),e}));